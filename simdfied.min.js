(function(){var e={version:"1.0.0"};"undefined"==typeof SIMD&&(console.log("SIMD is not natively supported in this browser (try firefox nightly). generating required SIMD polyfill"),SIMD={float32x4:function(a,b,c,d){return{x:parseFloat(a),y:parseFloat(b),z:parseFloat(c),w:parseFloat(d)}}},SIMD.float32x4.zero=function(){return{x:0,y:0,z:0,w:0}},SIMD.float32x4.add=function(a,b){return{x:a.x+b.x,y:a.y+b.y,z:a.z+b.z,w:a.w+b.w}},SIMD.float32x4.sub=function(a,b){return{x:a.x-b.x,y:a.y-b.y,z:a.z-b.z,w:a.w-
b.w}},SIMD.float32x4.mul=function(a,b){return{x:a.x*b.x,y:a.y*b.y,z:a.z*b.z,w:a.w*b.w}},SIMD.float32x4.div=function(a,b){return{x:a.x/b.x,y:a.y/b.y,z:a.z/b.z,w:a.w/b.w}},SIMD.float32x4.min=function(a,b){return{x:a.x<b.x?a.x:b.x,y:a.y<b.y?a.y:b.y,z:a.z<b.z?a.z:b.z,z:a.z<b.z?a.z:b.z}},SIMD.float32x4.max=function(a,b){return{x:a.x>b.x?a.x:b.x,y:a.y>b.y?a.y:b.y,z:a.z>b.z?a.z:b.z,z:a.z>b.z?a.z:b.z}},SIMD.float32x4.neg=function(a){return{x:-1*a.x,y:-1*a.y,z:-1*a.z,w:-1*a.w}});var m=m||function(a){return a.toString().replace(/\B(?=(\d{3})+(?!\d))/g,
",")},l=function(a){if(!a||"number"!=typeof a.length)throw"invalid input array";for(var b=[],c=4;c<=a.length;c+=4)b.push(SIMD.float32x4(a[c-4],a[c-3],a[c-2],a[c-1]));c=a.length%4;1==c?b.push(SIMD.float32x4(a[a.length-1],NaN,NaN,NaN)):2==c&&b.push(SIMD.float32x4(a[a.length-2],a[a.length-1],NaN,NaN));3==c&&b.push(SIMD.float32x4(a[a.length-3],a[a.length-2],a[a.length-1],NaN));return b},E=function(a){if(!a||"number"!=typeof a.length)throw"input input 2d array";for(var b=[],c=0;c<a.length;c++)b[c]=l(a[c]);
return b},r=function(a){var b=[];a.reduce(function(a,d){isNaN(d.w)?isNaN(d.z)?isNaN(d.y)?isNaN(d.x)||b.push(d.x):(b.push(d.x),b.push(d.y)):(b.push(d.x),b.push(d.y),b.push(d.z)):(b.push(d.x),b.push(d.y),b.push(d.z),b.push(d.w))},this);return b},F=function(a){return a.map(function(a){return SIMD.float32x4.mul(a,a)},this)},s=function(a){var b=a.reduce(function(a,b,e,f){return e<f.length-1?SIMD.float32x4.add(a,b):a},SIMD.float32x4.zero());a=a[a.length-1];return b.x+b.y+b.z+b.w+a.x+(isNaN(a.y)?0:a.y)+
(isNaN(a.z)?0:a.z)+(isNaN(a.w)?0:a.w)},x=function(a){var b=h(a);if(0<b)return s(a)/b;throw"empty simd vec";},G=function(a,b){b||(b=x(a));var c=h(a),d=SIMD.float32x4(b,b,b,b),e=a.map(function(a){a=SIMD.float32x4.sub(a,d);return SIMD.float32x4.mul(a,a)});return Math.sqrt(s(e)/(c-1))},h=function(a){if(!a||0==a.length)return 0;var b=0;isNaN(a[a.length-1].y)?b=3:isNaN(a[a.length-1].z)?b=2:isNaN(a[a.length-1].w)&&(b=1);return 4*a.length-b},H=function(a,b){if(h(a)!=h(b))throw"cannot add arrays with different sizes: "+
h(a)+" and "+h(b);return a.map(function(a,d){return SIMD.float32x4.add(a,b[d])},this)},I=function(a,b){if(h(a)!=h(b))throw"cannot subtract arrays with different sizes: "+h(a)+" and "+h(b);return a.map(function(a,d){return SIMD.float32x4.sub(a,b[d])},this)},J=function(a,b){var c=SIMD.float32x4(b,b,b,b);return a.map(function(a){return SIMD.float32x4.add(a,c)},this)},K=function(a,b){var c=SIMD.float32x4(b,b,b,b);return a.map(function(a){return SIMD.float32x4.sub(a,c)},this)},L=function(a,b){var c=SIMD.float32x4(b,
b,b,b);return a.map(function(a){return SIMD.float32x4.mul(a,c)},this)},n=function(a,b){if(h(a)!=h(b))throw"cannot mul vectors with different lengths: "+h(a)+" and "+h(b);return s(a.map(function(a,d){return SIMD.float32x4.mul(a,b[d])},this))},y=function(a,b){if(h(a)!=h(b))throw"cannot mul vectors with different lengths: "+h(a)+" and "+h(b);return a.map(function(a,d){return SIMD.float32x4.mul(a,b[d])},this)},M=function(a){return a.map(function(a){return SIMD.float32x4.neg(a)})},N=function(a){return a.map(function(a){return SIMD.float32x4(Math.log(a.x),
Math.log(a.y),Math.log(a.z),Math.log(a.w))})},O=function(a){return a.map(function(a){return SIMD.float32x4(Math.round(a.x),Math.round(a.y),Math.round(a.z),Math.round(a.w))})},P=function(a,b){return a.map(function(a,d){return SIMD.float32x4(a.x==b[d].x?1:0,a.y==b[d].y?1:0,a.z==b[d].z?1:0,a.w==b[d].w?1:0)},this)},R=function(a){return a.map(function(a){return SIMD.float32x4.div(SIMD.float32x4(1,1,1,1),SIMD.float32x4.add(SIMD.float32x4(1,1,1,1),Q(Math.E,SIMD.float32x4.neg(a))))})},u=function(a,b){return a.map(function(a){return SIMD.float32x4(isNaN(a.x)?
NaN:Math.pow(a.x,b),isNaN(a.y)?NaN:Math.pow(a.y,b),isNaN(a.z)?NaN:Math.pow(a.z,b),isNaN(a.w)?NaN:Math.pow(a.w,b))},this)},Q=function(a,b){return SIMD.float32x4(Math.pow(a,b.x),Math.pow(a,b.y),Math.pow(a,b.z),Math.pow(a,b.w))},z=function(a){var b=a.reduce(function(a,b,e,f){return e<f.length-1?SIMD.float32x4.min(a,b):a});a=a[a.length-1];b=[b.x,b.y,b.z,b.w,a.x];isNaN(a.y)||b.push(a.y);isNaN(a.z)||b.push(a.z);isNaN(a.w)||b.push(a.w);return b.sort(function(a,b){return a-b})[0]},A=function(a){var b=a.reduce(function(a,
b,e,f){return e<f.length-1?SIMD.float32x4.max(a,b):a});a=a[a.length-1];b=[b.x,b.y,b.z,b.w,a.x];isNaN(a.y)||b.push(a.y);isNaN(a.z)||b.push(a.z);isNaN(a.w)||b.push(a.w);return b.sort(function(a,b){return b-a})[0]},S=function(a){var b=[],c=Math.floor(a/4);a%=4;for(var d=0;d<c;d++)b[d]=SIMD.float32x4(1,1,1,1);1==a?b.push(SIMD.float32x4(1,NaN,NaN,NaN)):2==a?b.push(SIMD.float32x4(1,1,NaN,NaN)):3==a&&b.push(SIMD.float32x4(1,1,1,NaN));return b},T=function(a){var b=[],c=Math.floor(a/4);a%=4;for(var d=0;d<
c;d++)b[d]=SIMD.float32x4.zero();1==a?b.push(SIMD.float32x4(0,NaN,NaN,NaN)):2==a?b.push(SIMD.float32x4(0,0,NaN,NaN)):3==a&&b.push(SIMD.float32x4(0,0,0,NaN));return b},U=function(a,b,c){return l(r(a).slice(b,c))},V=function(a,b,c){for(var d=[],e=1;e<=c;e++)for(var f=0;f<=e;f++)d[d.length]=y(u(a,e-f),u(b,f));return d},t=function(a,b){if(isNaN(b)||b!=parseInt(b)||0>b)throw"invalid vector index "+b;if(b>=h(a))throw"vector index "+b+" out of range ("+h(a)+")";var c=Math.floor(b/4),d=b%4;return 0==d?a[c].x:
1==d?a[c].y:2==d?a[c].z:a[c].w},W=function(a,b){var c=[],c=b.map(function(b){return t(a,b)},this);return l(c)},p=function(a){return a&&0!=a.length?[h(a[0]),a.length]:[0,0]},X=function(a,b){if(!a||!a.length||0==a.length)throw"empty matrix";if(!b||!b.length||0==b.length)throw"empty vector";var c=p(a),d=h(b);if(c[0]!=d)throw"cannot multiply matrix size "+c[0]+" X "+c[1]+" with vector length "+d;c=[];for(d=0;d<a.length;d+=4)c[d/4]=SIMD.float32x4(a[d]?n(a[d],b):NaN,a[d+1]?n(a[d+1],b):NaN,a[d+2]?n(a[d+
2],b):NaN,a[d+3]?n(a[d+3],b):NaN);return c},Y=function(a){for(var b=[],c=a.length,d=a[0].length,e=h(a[0]),f=0;f<e;f++)b[f]=[];for(f=0;f<c;f+=4)for(var g=0;g<d;g++)b[4*g].push(SIMD.float32x4(a[f]&&a[f][g]?a[f][g].x:NaN,a[f+1]&&a[f+1][g]?a[f+1][g].x:NaN,a[f+2]&&a[f+2][g]?a[f+2][g].x:NaN,a[f+3]&&a[f+3][g]?a[f+3][g].x:NaN)),e-1>=4*g+1&&b[4*g+1].push(SIMD.float32x4(a[f]&&a[f][g]?a[f][g].y:NaN,a[f+1]&&a[f+1][g]?a[f+1][g].y:NaN,a[f+2]&&a[f+2][g]?a[f+2][g].y:NaN,a[f+3]&&a[f+3][g]?a[f+3][g].y:NaN)),e-1>=4*
g+2&&b[4*g+2].push(SIMD.float32x4(a[f]&&a[f][g]?a[f][g].z:NaN,a[f+1]&&a[f+1][g]?a[f+1][g].z:NaN,a[f+2]&&a[f+2][g]?a[f+2][g].z:NaN,a[f+3]&&a[f+3][g]?a[f+3][g].z:NaN)),e-1>=4*g+3&&b[4*g+3].push(SIMD.float32x4(a[f]&&a[f][g]?a[f][g].w:NaN,a[f+1]&&a[f+1][g]?a[f+1][g].w:NaN,a[f+2]&&a[f+2][g]?a[f+2][g].w:NaN,a[f+3]&&a[f+3][g]?a[f+3][g].w:NaN));return b},Z=function(a,b){if(isNaN(b)||b!=parseInt(b)||0>b)throw"invalid matrix row index "+b;var c=p(a);if(b>=c[0])throw"matrix row index "+b+" out of range ("+c[0]+
")";for(var d=[],e=0;e<c[1];e++)d.push(t(a[e],b));return l(d)},$=function(a,b){if(isNaN(b)||b!=parseInt(b)||0>b)throw"invalid matrix column index "+b;var c=p(a);if(b>=c[1])throw"matrix column index "+b+" out of range ("+c[1]+")";return a[b]},aa=function(a){if(a&&a.isSimdfiedVec)return a;this.vec=a?a.length?a:[]:[];this.isSimdfiedVec=!0;this.print=function(){for(var a=this.vec,c=[],d=0;d<a.length;d++)c.push("["),c.push(a[d].x),c.push(" "),c.push(a[d].y),c.push(" "),c.push(a[d].z),c.push(" "),c.push(a[d].w),
c.push("]");console.log(c.join(""))};this.map=function(){return this.vec.map.apply(this,arguments)};this.fromArray=function(a){return e.vec(l(a))};this.find=function(a){return e.vec(W(this.vec,a))};this.slice=function(a,c){return e.vec(U(this.vec,a,c))};this.ones=function(a){return e.vec(S(a))};this.zeros=function(a){return e.vec(T(a))};this.sqr=function(){return e.vec(F(this.vec))};this.neg=function(){return e.vec(M(this.vec))};this.log=function(){return e.vec(N(this.vec))};this.round=function(){return e.vec(O(this.vec))};
this.sigmoid=function(){return e.vec(R(this.vec))};this.add=function(a){return e.vec(H(this.vec,a.vec?a.vec:a))};this.sub=function(a){return e.vec(I(this.vec,a.vec?a.vec:a))};this.addScal=function(a){return e.vec(J(this.vec,a))};this.subScal=function(a){return e.vec(K(this.vec,a))};this.mulScal=function(a){return e.vec(L(this.vec,a))};this.mulElm=function(a){return e.vec(y(this.vec,a.vec?a.vec:a))};this.comp=function(a){return e.vec(P(this.vec,a.vec?a.vec:a))};this.pow=function(a){return e.vec(u(this.vec,
a))};this.length=function(){return h(this.vec)};this.item=function(a){return t(this.vec,a)};this.toArray=function(){return r(this.vec)};this.mul=function(a){return n(this.vec,a.vec?a.vec:a)};this.cartProd=function(a){var c=a.vec?a.vec:a;a=r(this.vec);for(var c=r(c),d=[],w=[],f=0;f<a.length;f++)for(var g=0;g<c.length;g++)d.push(a[f]),w.push(c[g]);a=[l(d),l(w)];return[e.vec(a[0]),e.vec(a[1])]};this.featMap=function(a,c){return e.mat(V(this.vec,a.vec?a.vec:a,c))};this.sum=function(){return s(this.vec)};
this.min=function(){return z(this.vec)};this.max=function(){return A(this.vec)};this.range=function(){return[z(this.vec),A(this.vec)]};this.std=function(a){return G(this.vec,a)};this.mean=function(){return x(this.vec)};return this};e.vec=function(a){return new aa(a)};var ba=function(a){if(a&&a.isSimdfiedMat)return a;this.mat=a?a.length?a:[]:[];this.isSimdfiedMat=!0;this.print=function(){for(var a=this.mat,c=[],d=0;d<a.length;d++){for(var e=0;e<a[0].length;e++)c.push("["),c.push(a[d][e].x),c.push(" "),
c.push(a[d][e].y),c.push(" "),c.push(a[d][e].z),c.push(" "),c.push(a[d][e].w),c.push("]");c.push("EOL\n")}console.log(c.join(""))};this.from2dArray=function(a){return e.mat(E(a))};this.concat=function(a){return e.mat(this.mat.concat(a.mat?a.mat:a))};this.addCol=function(a){return e.mat(this.mat.concat([a.vec?a.vec:a]))};this.trans=function(){return e.mat(Y(this.mat))};this.mulVec=function(a){return e.vec(X(this.mat,a.vec?a.vec:a))};this.size=function(){return p(this.mat)};this.row=function(a){return e.vec(Z(this.mat,
a))};this.col=function(a){return e.vec($(this.mat,a))};this.item=function(a,c){var d=this.mat;if(isNaN(a)||a!=parseInt(a)||0>a)throw"invalid matrix row index "+a;if(isNaN(c)||c!=parseInt(c)||0>c)throw"invalid matrix column index "+c;var e=p(d);if(a>=e[0])throw"matrix row index "+a+" out of range ("+e[0]+")";if(c>=e[1])throw"matrix column index "+c+" out of range ("+e[1]+")";return t(d[c],a)};return this};e.mat=function(a){return new ba(a)};var v=["linReg","logReg","kmeans"],B=["linear regression",
"logistic regression","K-means"],q=function(a){if("linReg"==a.algo)return e.mat(a.XNormT).mulVec(a.theta).vec;if("logReg"==a.algo)return e.mat(a.XNormT).mulVec(a.theta).sigmoid().vec},C=function(a){if("linReg"==a.algo){var b=e.vec(q(a));return 1/(2*a.m)*b.sub(a.yNorm).sqr().sum()}if("logReg"==a.algo){var b=e.vec(q(a)),c=e.vec(a.yNorm).neg(),d=c.mulElm(b.log()),b=c.addScal(1).mulElm(b.neg().addScal(1).log()),d=d.sub(b).sum(),d=1/a.m*d;a.settings.regLambda&&(b=e.vec(a.theta).sqr().sum()-Math.pow(a.theta[0].x,
2),d+=a.settings.regLambda/(2*a.m)*b);return d}},ca=function(a){var b=new Date;a.trainSize=Math.round(a.split[0]*a.m);a.testSize=a.m-a.trainSize;a.XNorm=[];a.XTest=[];a.mu=[];a.sigma=[];a.settings.addInter&&(a.XNorm[0]=e.vec().ones(a.trainSize).vec,0<a.testSize&&(a.XTest[0]=e.vec().ones(a.testSize)));a.settings.featMap&&1<a.X.length&&(a.XNorm=a.XNorm.concat(e.vec(a.X[0]).slice(0,a.trainSize).featMap(e.vec(a.X[1]).slice(0,a.trainSize),a.settings.featMap).mat),a.XTest=a.XTest.concat(e.vec(a.X[0]).slice(a.trainSize,
a.trainSize+a.testSize).featMap(e.vec(a.X[1]).slice(a.trainSize,a.trainSize+a.testSize),a.settings.featMap).mat));for(var c=0;c<a.X.length;c++){a.mu[c]=e.vec(a.X[c]).mean();a.sigma[c]=e.vec(a.X[c]).std(a.mu[c]);var d=SIMD.float32x4(a.mu[c],a.mu[c],a.mu[c],a.mu[c]),h=SIMD.float32x4(a.sigma[c],a.sigma[c],a.sigma[c],a.sigma[c]);a.XNorm[c+a.settings.addInter]=e.vec(a.X[c]).slice(0,a.trainSize).vec.map(function(b){return a.settings.normMeanStd?SIMD.float32x4.div(SIMD.float32x4.sub(b,d),h):b},this);0<a.testSize&&
(a.XTest[c+a.settings.addInter]=e.vec(a.X[c]).slice(a.trainSize,a.trainSize+a.testSize).vec.map(function(b){return a.settings.normMeanStd?SIMD.float32x4.div(SIMD.float32x4.sub(b,d),h):b},this))}a.yNorm=e.vec(a.y).slice(0,a.trainSize).vec;a.yTest=e.vec(a.y).slice(a.trainSize,a.trainSize+a.testSize);console.log("normalization done ("+m(new Date-b)+"ms)");b=new Date;a.XNormT=e.mat(a.XNorm).trans().mat;0<a.testSize&&(a.XTestT=e.mat(a.XTestT).trans().mat)},D=function(a){a.kmeansCentroids=[];a.kmeansIdx=
[];a.x1Range=e.mat(a.X).col(0).range();a.x2Range=e.mat(a.X).col(1).range();for(var b=0;b<a.settings.kmeansK;b++){var c=[];c.push(a.x1Range[0]+Math.random()*(a.x1Range[1]-a.x1Range[0]));c.push(a.x2Range[0]+Math.random()*(a.x2Range[1]-a.x2Range[0]));a.kmeansCentroids.push(c)}},da=function(a){a.kmeansCentroids||D(a);for(i=0;i<a.settings.kmeansIter;i++){for(var b=0;b<a.m;b++)for(var c=null,c=e.mat(a.X).row(b).toArray(),d=0,h=0;h<a.settings.kmeansK;h++){for(var f=a.kmeansCentroids[h],g=0,k=0;k<a.n;k++)g+=
Math.pow(c[k]-f[k],2);if(0==h||g<d)d=g,a.kmeansIdx[b]=h}for(h=0;h<a.settings.kmeansK;h++)if(b=a.kmeansIdx.map(function(a,b){return a==h?b:null},this).filter(function(a){return null!=a},this),0<b.length)for(k=0;k<a.n;k++)a.kmeansCentroids[h][k]=e.vec(a.X[k]).find(b).mean()}},ea=function(a){if(a&&a.isSimdfiedMl)return a;this.ml=a?a:{split:[1,0,0],settings:{addInter:!0,normMeanStd:!0,regLambda:!1,iter:1500,alpha:.01,kmeansK:3,kmeansIter:10}};this.isSimdfiedMl=!0;this.algo=function(a){if("string"!=typeof a||
-1==v.indexOf(a))throw"non supported algorithm "+a+". supported algorithms: "+v.join(" ");this.ml.algo=a;return e.ml(this.ml)};this.X=function(a){if(!a||!a.isSimdfiedMat)throw"X must be a non empty simdfied matrix";var c=a.size();if(2>c[0]+c[1])throw"X must be a non empty simdfied matrix";this.ml.X=a.mat;this.ml.m=c[0];this.ml.n=c[1];return e.ml(this.ml)};this.y=function(a){if(!a||!a.isSimdfiedVec||0==a.length())throw"y must be a non empty simdfied vector";this.ml.y=a;return e.ml(this.ml)};this.split=
function(a){if(!a||!a.length||3!=a.length)throw"split must be a 3 element array for train, test and cross-validation precentage split";var c=0;a=a.map(function(a){if(isNaN(a)||parseInt(a)!=a||0>a||100<a)throw"split percentage item must be an int ranging from 0 to 100";c+=a;return a/100});if(100!=c)throw"split percentage items total must equal to 100";this.ml.split=a;return e.ml(this.ml)};this.set=function(a,c){if(!a||"string"!=typeof a||0==a.length)throw"setting key must be a non empty string";if(-1==
["number","boolean"].indexOf(typeof c))throw"setting value must be a boolean or a number";this.ml.settings[a]=c;return e.ml(this.ml)};this.reset=function(){switch(this.ml.algo){case "kmeans":D(this.ml)}};this.run=function(){if(!this.ml.algo)throw'algorithm type must be specified using the "algo" function';if(!this.ml.X)throw'X must be specified using the "X" function';var a=v.indexOf(this.ml.algo);if(!this.ml.y&&-1!=["linReg","logReg"].indexOf(this.ml.algo))throw"y must be specified for "+B[a]+' using the "y" function';
console.log("running "+B[a]);switch(this.ml.algo){case "linReg":case "logReg":ca(this.ml);a=this.ml;timeStamp=new Date;a.theta=e.vec().zeros(a.XNorm.length).vec;a.cost=[];a.cost[0]=C(a);console.log("initial cost: "+m(a.cost[0].toFixed(2)));for(var c=1;c<a.settings.iter+1;c++){var d=q(a),d=e.vec(d).sub(a.yNorm),d=e.mat(a.XNorm).mulVec(d);a.theta=e.vec(a.theta).sub(d.mulScal(a.settings.alpha/a.m)).vec;d=C(a);if(-1!=[Infinity,-Infinity,NaN].indexOf(d)||d>a.cost[c-1])break;else a.cost[c]=d}console.log("gradientDescent done ("+
m(new Date-timeStamp)+"ms)");console.log("cost after #"+a.cost.length+" iterations "+m(a.cost[c-1].toFixed(2)));a=this.ml;switch(a.algo){case "logReg":c=q(a),c=e.vec(c).sigmoid().round(),a.trainAcurr=e.vec(a.yNorm).comp(c).sum()/e.vec(a.yNorm).length(),console.log("train acurracy: "+100*a.trainAcurr+"%")}if(0<a.testSize)switch(a.algo){case "logReg":c=e.mat(a.XTestT).mulVec(a.theta),c=e.vec(c).sigmoid().round(),a.testAcurr=e.vec(a.yTest).comp(c).sum()/e.vec(a.yTest).length(),console.log("test acurracy: "+
(100*a.testAcurr).toFixed(1)+"%")}break;case "kmeans":da(this.ml)}return e.ml(this.ml)};this.hipo=function(){return q(this.ml)};this.predOne=function(a){var c=this.ml;if(-1==["linReg","logReg"].indexOf(c.algo))throw"prediction is not available for this algorithm";var d=a.slice();if(c.settings.normMeanStd)for(var h=0;h<d.length;h++)d[h]=(d[h]-c.mu[h])/c.sigma[h];c.settings.addInter&&d.unshift(1);d=e.vec().fromArray(d).mul(c.theta);"logReg"==c.algo&&(d=d.sigmoid());switch(c.algo){case "linReg":console.log("predicting for features ["+
a+"] the value of "+m(d.toFixed(2)));break;case "logReg":console.log("predicting for features ["+a+"] a label of "+d.toFixed(2))}return d};return this};e.ml=function(a){return new ea(a)};this.simdfied=e})();
